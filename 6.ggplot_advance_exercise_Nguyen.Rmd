---
title: "6.ggplot_advance_exercise_Nguyen"
author: "Nguyen Truong"
date: "2025-04-16"
output: 
  html_document
    toc: yes
    toc_float: yes
    collapse: false
    smooth_scroll: false
    code_folding: hide  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(plotly)
library(gganimate)
library(highcharter)
library(gifski)
library(gridExtra)
library(cowplot)
library(COVID19)
rm(list = ls())
```

#1. Data
World-wide Covid-19 data will be downloaded using the `COVID19` R package. This package is able to download COVID-19 data across governmental sources at national, regional, and city level. The dataset includes: 

- standard COVID-19 variables: total population, cumulative number of cases, tests, deaths, recovered, daily number of hospitalized, patients requiring ventilation and intensive therapy. 
- policy measures by Oxford COVID-19 Government Response Tracker (Hale et al.,2020) 
- geographic information suited for data visualization and for interfacing with external databases (e.g. weather information, geo-located tweets). 
- external identifiers allowing to extend the dataset with World Bank Open Data, Google mobility reports, and Apple mobility reports. Governmental identifiers are provided to further extend the dataset with local, fine-grained statistics. 
For more info on this unified dataset, visit their data hub (https://covid19datahub.io/). 


```{r getdata, message = FALSE, warning = FALSE}
#Get COVID data from Belgium at national level
data1 <- covid19(country = c("Belgium"), start = "2020-03-01", verbose = FALSE)
data1 <- data1[data1$date <= "2020-12-31",]  #get data until 2020-12-31
data1 <- data1 %>% 
  arrange(date) %>% group_by(administrative_area_level_1) %>%
  mutate(confirmed_daily = c(data1$confirmed[1], diff(confirmed))) %>%   #diff(): calculate the difference between each consecutive row in the confirmed column
  ungroup()

data2 <- covid19(country = c("Belgium"), start = "2020-03-01", level = 2, verbose = FALSE)
data2 <- data2[data2$date <= "2020-12-31", ]
data2 <- data2[data2$administrative_area_level_2 != "Ostbelgien", ]  #removing the Ostbelgien entries since they do not contain the number of confirmed cases or number of hospitalisations

#Get COVID19 data from multiple countries at national level
data3 <- covid19(country = c("Belgium", "Netherlands", "France", "Germany", "United Kingdom"), start = "2020-03-01", verbose = FALSE)
data3 <- data3[data3$date <= "2020-12-31",]

# In case the code above fails to download the data, please load a pre-downloaded version here:
# load(".../data/covid19_belgium.RData")

```

The covid19 datasets contain a lot of information such as:

* confirmed cases (`confirmed`)
* number of deaths (`deaths`)
* number of hospitalized patients (`hosp`)
* The level at which the numbers were recorded
    + `administrative_area_level_1` for `data1`
    + `administrative_area_level_2` for `data2`
* population size of `administrative_area_level_1` or `administrative_area_level_2` (`population`)
* numerous restrictions (`school_closing`, `cancel_events`,`gathering_restrictions`,...)
    + more info on the meaning of the restriction levels can be found at https://github.com/OxCGRT/covid-policy-tracker/blob/master/documentation/codebook.md#containment-and-closure-policies
* number of recovered cases (`recovered`)
* ...

```{r showData}
str(data1)
str(data2)
```
#2. Exercise ggplot
##Exercise1: 
Use data1 to visualize the daily confirmed cases in Belgium over time with a *colored line*. Also make sure *all months (with year) appear on the x-axis* and give the graph a title.
```{r}
p1 <- ggplot(data = data1, aes(x = date, y= confirmed_daily, color = administrative_area_level_1)) +
  geom_line() +
  labs(
    x = "Time",
    y = "The daily confirmed cases",
    title = "The daily confirmed COVID19 cases in Belgium over time"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = format("%B %Y")) +   #date_labels=format("%d %W %B %Y") = day-week-month-year
  theme(axis.text.x = element_text (angle = 60, hjust = 1))
  
p2 <- ggplot(data = data1, aes(x = date, y= confirmed_daily, color = administrative_area_level_1)) +
  geom_smooth(method = "loess", span = 0.1) +     #methed: be default as loess (Local Estimated Scatterplot Smoothing), 
  labs(
    x = "Time",
    y = "The daily confirmed cases",
    title = "The daily confirmed COVID19 cases in Belgium over time"
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = format("%B %Y")) +   #date_labels=format("%d %W %B %Y") = day-week-month-year
  theme(axis.text.x = element_text (angle = 60, hjust = 1)) 

#Combine these plots into a single plot grid using either the gridExtra or cowplot package.
grid.arrange(p1, p2, nrow = 1)  #using gridExtra package
plot_grid(p1, p2)  #using cowplot package
```
##Exercise 2
using data2, visualize the number of hospitalizations over time in the 3 main regions of Belgium. Make sure the 3 regions are separated in 3 facets and give each line (for each region) a manual color! (pick your favorite colors)
```{r}
ggplot(data = data2, aes(x = date, y = hosp, col = administrative_area_level_2)) +
  geom_line() +
  facet_wrap(~administrative_area_level_2) +
  scale_color_manual(values = c("red", "green", "blue")) +
  labs(y = "Number of hospitalizazion") +
  theme_bw()

ggplot(data = data2, aes(x = date, y = hosp/population, col = administrative_area_level_2)) +
  geom_line() +
  facet_wrap(~administrative_area_level_2) +
  scale_color_manual(values = c("red", "green", "blue")) +
  labs(y = "Rate of hospitalizazion") +
  theme_bw()



```

